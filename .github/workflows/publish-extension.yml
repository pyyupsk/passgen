name: Publish Extension

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    name: Build & Publish Extensions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install --frozen-lockfile
        working-directory: extension

      - name: Build Chrome extension
        run: bun run zip
        working-directory: extension

      - name: Build Firefox extension
        run: bun run zip:firefox
        working-directory: extension

      - name: Upload to Firefox Add-ons
        uses: wdzeng/firefox-addon@b78a4d0148897b072ef18aff65a6bd793e8109be # v1.2.0
        with:
          addon-guid: ${{ secrets.FIREFOX_ADDON_GUID }}
          xpi-path: extension/.output/*-firefox.zip
          source-file-path: extension/.output/*-sources.zip
          jwt-issuer: ${{ secrets.FIREFOX_JWT_ISSUER }}
          jwt-secret: ${{ secrets.FIREFOX_JWT_SECRET }}

      - name: Generate Changelog
        if: github.event_name == 'release'
        run: bunx changelogithub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            extension/.output/*-chrome.zip
            extension/.output/*-firefox.zip
